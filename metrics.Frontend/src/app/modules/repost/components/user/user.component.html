<mat-expansion-panel [expanded]="true">
  <mat-expansion-panel-header>
    <mat-panel-title class="mat-h3">
      Поиск
    </mat-panel-title>
  </mat-expansion-panel-header>
  <div class="flex flex-wrap">
    <form class="w-1/2" [formGroup]="form" (ngSubmit)="onSubmit()">
      <mat-form-field class="w-1/3 mr-6">
        <input
          type="search"
          placeholder="Текст"
          matInput
          autocomplete="off"
          formControlName="search"
        />
      </mat-form-field>
      <mat-form-field class="w-1/3">
        <input
          placeholder="Юзер"
          type="text"
          matInput
          formControlName="user"
          [matAutocomplete]="auto"
        />
        <button
          *ngIf="form.get('user').value"
          (click)="clearUser($event)"
          matSuffix
          mat-button
          mat-icon-button
        >
          <mat-icon>close</mat-icon>
        </button>
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
          <mat-option *ngFor="let option of users" [value]="option">
            <figure class="flex items-center">
              <img class="h-10 mr-3" [src]="option.Avatar" />
              <figcaption>{{ option.FullName }}</figcaption>
            </figure>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <p>
        <button
          [disabled]="!form.valid"
          mat-raised-button
          color="primary"
          type="submit"
        >
          Отправить
        </button>
      </p>
    </form>
    <div class="w-1/2">
      <button
        class="w-1/3"
        (click)="repostAll()"
        mat-button
        [color]="'primary'"
        [disabled]="selectedMessages.length === 0"
      >
        Репост всех
      </button>
      <mat-slider
        class="mr-6 w-1/3"
        thumbLabel
        [value]="timeout"
        (valueChange)="sliderChange($event)"
        [step]="1"
        [min]="30"
        [max]="60"
        [disabled]="selectedMessages.length === 0"
      ></mat-slider>
      <span class="w-1/5" *ngIf="selectedMessages.length">{{
        selectedMessages.length
      }}</span>
    </div>
  </div>
  <div class="flex items-center flex-row-reverse">
    <mat-paginator
      [showFirstLastButtons]="true"
      (page)="onChangePage($event)"
      [pageSize]="pageSize"
      [length]="total"
      [pageIndex]="page"
      [pageSizeOptions]="pageSizeOptions"
    >
    </mat-paginator>
    <mat-form-field class="pr-3">
      <div class="flex items-center">
        <input
          placeholder="Страница"
          (keyup.enter)="onSubmit()"
          type="number"
          min="0"
          matInput
          [(ngModel)]="page"
        />
        <button matSuffix (click)="onCustomPageChange()">
          <mat-icon>navigate_next</mat-icon>
        </button>
      </div>
    </mat-form-field>
  </div>
</mat-expansion-panel>
<div
  class="h-full w-full flex flex-wrap justify-center mt-3 p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
  [ngClass]="messages.length > 0 && !loading ? 'mat-elevation-z10' : ''"
>
  <div class="loading-shade" *ngIf="loading; else card">
    <mat-spinner *ngIf="loading"></mat-spinner>
  </div>
  <ng-template #card>
    <mat-card class="text-sm" *ngFor="let message of messages; trackBy: track">
      <mat-card-header>
        <mat-card-title class="flex items-center w-full">
          <a
            target="_blank"
            class="block flex-1"
            [href]="'https://vk.com/wall' + message.Owner_Id + '_' + message.Id"
          >
            Пост
          </a>
          <mat-slide-toggle
            *ngIf="!message.Reposts.User_reposted"
            [color]="'accent'"
            (change)="onSelect($event, message)"
            [checked]="message.IsSelected"
          ></mat-slide-toggle>
        </mat-card-title>
        <mat-card-subtitle>{{ fromUnixTime(message.Date) }}</mat-card-subtitle>
      </mat-card-header>
      <app-vk-image [src]="images(message)"></app-vk-image>
      <mat-card-content [innerHTML]="message.Text" class="h-32 overflow-auto text-xs">
      </mat-card-content>
      <mat-card-footer class="text-center">
        <mat-form-field class="message-category">
          <mat-label>{{ message.MessageCategoryPredict }}</mat-label>
          <mat-select
            (selectionChange)="setType(message.Id, message.Owner_Id, $event)"
            [value]="message.MessageCategoryId"
            panelClass="mat-select-full-height"
          >
            <mat-option *ngFor="let el of categories" [value]="el.Id">
              <div class="flex flex-wrap items-center">
                <span class="flex-1">{{ el.Title }}</span>
                <div class="w-3 h-3" [style.background]="el.Color"></div>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-footer>
      <mat-card-actions>
        <button mat-button (click)="like(message.Owner_Id, message.Id)">
          <mat-icon [color]="message.Likes.User_Likes ? 'warn' : 'primary'"
            >thumb_up
          </mat-icon>
          {{ message.Likes.Count }}
        </button>
        <button mat-button (click)="repost(message.Owner_Id, message.Id)">
          <mat-icon [color]="message.Reposts.User_reposted ? 'warn' : 'primary'"
            >share
          </mat-icon>
          {{ message.Reposts.Count }}
        </button>
      </mat-card-actions>
    </mat-card>
  </ng-template>
</div>
